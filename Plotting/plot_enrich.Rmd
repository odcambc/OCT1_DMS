---
title: "Enrich2 output parsing and plotting - for OCT1"
output: html_notebook
---

```{r}
library(ggplot2)
library(gglorenz)
library(readr)
library(stringr)
library(dplyr)
library(hrbrthemes)
library(tidyverse)
library(ggthemes)
library(ggridges)
library(ggpubr)
library(bio3d)
library(colorspace)
library(reshape2)
library(bio3d.ggplot)
source("dms_analysis_utilities.R")

```

Import the data for plotting

```{r}
# Enrich2 score files
oct1_scores_file ="../data/Enrich2/Oct1_full/tsv/OCT1_full_exp/main_identifiers_scores.tsv"
oct1_scores_shared_file ="../data/Enrich2/Oct1_full/tsv/OCT1_full_exp/main_identifiers_scores_shared.tsv"

oct1_variantscore_colnames <- c("hgvs", "SE", "epsilon", "score")
oct1_variantscore_coltypes <- c("character", "numeric", "numeric", "numeric")

oct1_scores <- read_delim(oct1_scores_file, col_names = oct1_variantscore_colnames, skip=3)
oct1_scores <- process_hgvs_df(oct1_scores)

oct1_variantscore_colnames <- c("hgvs", "SM73_0_SE", "SM73_0_epsilon", "SM73_0_score", "SM73_1_SE", "SM73_1_epsilon", "SM73_1_score", "GFP_SE", "GFP_epsilon", "GFP_score")
oct1_variantscore_coltypes <- c("character", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric")

oct1_shared_colnames <- c("hgvs", "SM73_0_SE_R1", "SM73_0_score_R1",
                                "SM73_0_SE_R2", "SM73_0_score_R2",
                                "SM73_0_SE_R3", "SM73_0_score_R3",
                                "SM73_1_SE_R1", "SM73_1_score_R1",
                                "SM73_1_SE_R2", "SM73_1_score_R2",
                                "SM73_1_SE_R3", "SM73_1_score_R3",
                                "GFP_SE_R1", "GFP_score_R1",
                                "GFP_SE_R2", "GFP_score_R2",
                                "GFP_SE_R3", "GFP_score_R3")
oct1_shared_coltypes <- c("character", "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric")

oct1_scores <- read_delim(oct1_scores_file, col_names = oct1_variantscore_colnames, skip=3)
oct1_scores <- process_hgvs_df(oct1_scores)

oct1_scores_shared <- read_delim(oct1_scores_shared_file, col_names = oct1_shared_colnames, skip=5)

# Enrich2 does not calculate scores if a variant in a replicate goes to 0 counts at some point.
# This calculates a score for those cases by averaging the scores for the other replicates.
oct1_scores_shared <- oct1_scores_shared %>%  rowwise() %>%
                                mutate(SM73_0_score = mean(c_across(starts_with("SM73_0_score")), na.rm=TRUE),
                                SM73_1_score = mean(c_across(starts_with("SM73_1_score")), na.rm=TRUE),
                                GFP_score = mean(c_across(starts_with("GFP_score")), na.rm=TRUE))

oct1_scores_shared <- process_hgvs_df(oct1_scores_shared %>% select(c(hgvs, SM73_0_score, SM73_1_score, GFP_score)))
oct1_scores_shared$is.wt = oct1_scores_shared$mutation_type == "S"
oct1_scores <- oct1_scores_shared

```

```{r}
plot <- ggplot(oct1_scores %>% filter(mutation_type != "X")) +
  geom_density(aes(x = SM73_0_score), size=2) +
  xlab("Enrich2 score (0 µM [SM73])") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  scale_color_brewer(
    type = "seq",
    palette = 'Oranges',
    direction = 1,
    aesthetics = 'color'
  ) +
  facet_grid(rows = vars(mutation_type))

ggsave("Plots/DFE_kernel_SM73_0_OCT1.png", plot = plot, height = 11, width = 8.5)
ggsave("Plots/DFE_kernel_SM73_0_OCT1.pdf", plot = plot, height = 11, width = 8.5)

plot <- ggplot(oct1_scores %>% filter(mutation_type != "X")) +
  geom_density(aes(x = SM73_1_score), size=2) +
  xlab("Enrich2 score (1 µM [SM73])") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  scale_color_brewer(
    type = "seq",
    palette = 'Oranges',
    direction = 1,
    aesthetics = 'color'
  ) +
  facet_grid(rows = vars(mutation_type))

ggsave("Plots/DFE_kernel_SM73_1_OCT1.png", plot = plot, height = 11, width = 8.5)
ggsave("Plots/DFE_kernel_SM73_1_OCT1.pdf", plot = plot, height = 11, width = 8.5)

plot <- ggplot(oct1_scores %>% filter(mutation_type != "X")) +
  geom_density(aes(x = GFP_score), size=2) +
  xlab("Enrich2 score (GFP)") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  scale_color_brewer(
    type = "seq",
    palette = 'Oranges',
    direction = 1,
    aesthetics = 'color'
  ) +
  facet_grid(rows = vars(mutation_type))

ggsave("Plots/DFE_kernel_GFP_OCT1.png", plot = plot, height = 11, width = 8.5)
ggsave("Plots/DFE_kernel_GFP_OCT1.pdf", plot = plot, height = 11, width = 8.5)


```



```{r}
variant_df = oct1_scores %>% filter(mutation_type != "X")

physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1")

ggplot(data = variant_df, aes(x=pos, y=GFP_score)) + 
  geom_point() +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  labs(x = "Position", y = "Enrich score  (Abundance)") + 
  theme_classic()

ggplot(data = variant_df,
       aes(x=factor(mutation_type, level = physical_order),
            y=GFP_score)) + 
  geom_hline(yintercept=0) +
  geom_violin(outlier.colour=NA) +
  xlab("Variant") + ylab("Enrich score  (Abundance)") +
  labs(x = "Mutation") +
  theme_classic()

ggplot(data = variant_df %>% 
        group_by(pos) %>% summarise(score = mean(GFP_score, na.rm=TRUE), pos = first(pos), mutation_type=first(mutation_type)), aes(x=pos, y=score, fill=mutation_type)) +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  geom_bar(stat="identity") +
  geom_vline(xintercept = 100, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 200, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 300, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 400, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 500, linestyle = 'dashed', lty = 2) + 
  theme_classic()

ggplot(variant_df) +
  geom_density(aes(x = GFP_score), bw=0.01, size=1) +
  xlab("Enrich2 score (Abundance)") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  facet_grid(rows = vars(mutation_type))

plot <- ggplot(variant_df, aes(x = GFP_score, y = mutation_type)) +
  geom_density_ridges(scale=1) +
  geom_point(aes(color=pos), 
    position = position_jitter(height=0.05, width = 0), size=0.25) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_color_gradient(high = "#49006a", low = "#fff7f3", aesthetics = "color") +
  xlab("Enrich2 score (Abundance)") +
  ylab("Mutation type") +
  labs(colour = "Residue position") +
  theme_ridges()

ggsave("Plots/DFE_kernel_2_GFP_OCT1.png", plot = plot, height = 11, width = 8.5)
ggsave("Plots/DFE_kernel_2_GFP_OCT1.pdf", plot = plot, height = 11, width = 8.5)

```

```{r}
variant_df = oct1_scores %>% filter(mutation_type != "X")

physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1")

ggplot(data = variant_df, aes(x=pos, y=SM73_0_score)) + 
  geom_point() +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  labs(x = "Position", y = "Enrich score  (0 µM [SM73])") + 
  theme_classic()

ggplot(data = variant_df,
       aes(x=factor(mutation_type, level = physical_order),
            y=SM73_0_score)) + 
  geom_hline(yintercept=0) +
  geom_violin(outlier.colour=NA) +
  xlab("Variant") + ylab("score") +
  labs(x = "Mutation") +
  theme_classic()

ggplot(data = variant_df %>% 
        group_by(pos) %>% summarise(score = mean(SM73_0_score, na.rm=TRUE), pos = first(pos), mutation_type=first(mutation_type)), aes(x=pos, y=score, fill=mutation_type)) +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  geom_bar(stat="identity") +
  geom_vline(xintercept = 100, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 200, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 300, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 400, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 500, linestyle = 'dashed', lty = 2) + 
  theme_classic()

ggplot(variant_df) +
  geom_density(aes(x = SM73_0_score), bw=0.01, size=1) +
  xlab("Enrich2 score") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  facet_grid(rows = vars(mutation_type))

plot <- ggplot(variant_df, aes(x = SM73_0_score, y = mutation_type)) +
  geom_density_ridges(scale=1) +
  geom_point(aes(color=pos), 
    position = position_jitter(height=0.05, width = 0), size=0.25) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_color_gradient(high = "#49006a", low = "#fff7f3", aesthetics = "color") +
  xlab("Enrich2 score") +
  ylab("Mutation type") +
  labs(colour = "Residue position") +
  theme_ridges()

ggsave("Plots/DFE_kernel_2_SM73_0_OCT1.png", plot = plot, height = 11, width = 8.5)
ggsave("Plots/DFE_kernel_2_SM73_0_OCT1.pdf", plot = plot, height = 11, width = 8.5)

```

```{r}
variant_df = oct1_scores %>% filter(mutation_type != "X")

physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1")

ggplot(data = variant_df, aes(x=pos, y=SM73_1_score)) + 
  geom_point() +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  labs(x = "Position") + 
  theme_classic()

ggplot(data = variant_df,
       aes(x=factor(mutation_type, level = physical_order),
            y=SM73_1_score)) + 
  geom_hline(yintercept=0) +
  geom_violin(outlier.colour=NA) +
  xlab("Variant") + ylab("score") +
  labs(x = "Mutation") +
  theme_classic()

ggplot(data = variant_df %>% 
        group_by(pos) %>% summarise(score = mean(SM73_1_score, na.rm=TRUE), pos = first(pos), mutation_type=first(mutation_type)), aes(x=pos, y=score, fill=mutation_type)) +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  geom_bar(stat="identity") +
  geom_vline(xintercept = 100, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 200, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 300, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 400, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 500, linestyle = 'dashed', lty = 2) + 
  theme_classic()

ggplot(variant_df) +
  geom_density(aes(x = SM73_1_score), bw=0.01, size=1) +
  xlab("Enrich2 score") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  facet_grid(rows = vars(mutation_type))

plot <- ggplot(variant_df, aes(x = SM73_1_score, y = mutation_type)) +
  geom_density_ridges(scale=1) +
  geom_point(aes(color=pos), 
    position = position_jitter(height=0.05, width = 0), size=0.25) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_color_gradient(high = "#49006a", low = "#fff7f3", aesthetics = "color") +
  xlab("Enrich2 score") +
  ylab("Mutation type") +
  labs(colour = "Residue position") +
  theme_ridges()

ggsave("Plots/DFE_kernel_2_SM73_1_OCT1.png", plot = plot, height = 11, width = 8.5)
ggsave("Plots/DFE_kernel_2_SM73_1_OCT1.pdf", plot = plot, height = 11, width = 8.5)

```

OCT1 heatmap - 0 µM SM73
```{r}

order <- c('D_1', 'H', 'K', 'R', 'D', 'E',
          'C', 'M', 'N', 'Q', 'S', 'T', 'A', 'I', 'L', 'V', 'W', 'F',
          'Y', 'G', 'P')

heatmap_limits = c(-1,1)

oct1_wt = "MPTVDDILEQVGESGWFQKQAFLILCLLSAAFAPICVGIVFLGFTPDHHCQSPGVAELSQRCGWSPAEELNYTVPGLGPAGEAFLGQCRRYEVDWNQSALSCVDPLASLATNRSHLPLGPCQDGWVYDTPGSSIVTEFNLVCADSWKLDLFQSCLNAGFLFGSLGVGYFADRFGRKLCLLGTVLVNAVSGVLMAFSPNYMSMLLFRLLQGLVSKGNWMAGYTLITEFVGSGSRRTVAIMYQMAFTVGLVALTGLAYALPHWRWLQLAVSLPTFLFLLYYWCVPESPRWLLSQKRNTEAIKIMDHIAQKNGKLPPADLKMLSLEEDVTEKLSPSFADLFRTPRLRKRTFILMYLWFTDSVLYQGLILHMGATSGNLYLDFLYSALVEIPGAFIALITIDRVGRIYPMAMSNLLAGAACLVMIFISPDLHWLNIIIMCVGRMGITIAIQMICLVNAELYPTFVRNLGVMVCSSLCDIGGIITPFIVFRLREVWQALPLILFAVLGLLAAGVTLLLPETKGVALPETMKDAENLGRKAKPKENTIYLKVQTSEPSGT"

oct_wt_1 = str_split(substr(oct1_wt, 1, 100), '')[[1]]
oct_wt_2 = str_split(substr(oct1_wt, 101, 200), '')[[1]]
oct_wt_3 = str_split(substr(oct1_wt, 201, 300), '')[[1]]
oct_wt_4 = str_split(substr(oct1_wt, 301, 400), '')[[1]]
oct_wt_5 = str_split(substr(oct1_wt, 401, 500), '')[[1]]
oct_wt_6 = str_split(substr(oct1_wt, 501, 550), '')[[1]]

#surface plot
SM73_0_1 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(1:100),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_0_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(1, 100),
                      labels = oct_wt_1,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_0_2 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(101:200),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_0_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(101, 200),
                      labels = oct_wt_2,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_0_3 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(201:300),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_0_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(201, 300),
                      labels = oct_wt_3,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_0_4 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(301:400),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_0_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(301, 400),
                      labels = oct_wt_4,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")


SM73_0_5 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(401:500),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_0_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(401, 500),
                      labels = oct_wt_5,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_0_6 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(501:550),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_0_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(501, 550),
                      labels = oct_wt_6,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="right"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_0_DMS = ggarrange(SM73_0_1, SM73_0_2, SM73_0_3, SM73_0_4, SM73_0_5, SM73_0_6,
                        nrow = 6, ncol = 1)

ggsave("Plots/Heatmap_SM73_0_OCT1.pdf", plot = SM73_0_DMS, height = 11, width = 8.5)
ggsave("Plots/Heatmap_SM73_0_OCT1.png", plot = SM73_0_DMS, height = 11, width = 8.5)
```

OCT1 heatmap - 1 µM SM73
```{r}

order <- c('D_1', 'H', 'K', 'R', 'D', 'E',
          'C', 'M', 'N', 'Q', 'S', 'T', 'A', 'I', 'L', 'V', 'W', 'F',
          'Y', 'G', 'P')

heatmap_limits = c(-3,3)

oct1_wt = "MPTVDDILEQVGESGWFQKQAFLILCLLSAAFAPICVGIVFLGFTPDHHCQSPGVAELSQRCGWSPAEELNYTVPGLGPAGEAFLGQCRRYEVDWNQSALSCVDPLASLATNRSHLPLGPCQDGWVYDTPGSSIVTEFNLVCADSWKLDLFQSCLNAGFLFGSLGVGYFADRFGRKLCLLGTVLVNAVSGVLMAFSPNYMSMLLFRLLQGLVSKGNWMAGYTLITEFVGSGSRRTVAIMYQMAFTVGLVALTGLAYALPHWRWLQLAVSLPTFLFLLYYWCVPESPRWLLSQKRNTEAIKIMDHIAQKNGKLPPADLKMLSLEEDVTEKLSPSFADLFRTPRLRKRTFILMYLWFTDSVLYQGLILHMGATSGNLYLDFLYSALVEIPGAFIALITIDRVGRIYPMAMSNLLAGAACLVMIFISPDLHWLNIIIMCVGRMGITIAIQMICLVNAELYPTFVRNLGVMVCSSLCDIGGIITPFIVFRLREVWQALPLILFAVLGLLAAGVTLLLPETKGVALPETMKDAENLGRKAKPKENTIYLKVQTSEPSGT"

oct_wt_1 = str_split(substr(oct1_wt, 1, 100), '')[[1]]
oct_wt_2 = str_split(substr(oct1_wt, 101, 200), '')[[1]]
oct_wt_3 = str_split(substr(oct1_wt, 201, 300), '')[[1]]
oct_wt_4 = str_split(substr(oct1_wt, 301, 400), '')[[1]]
oct_wt_5 = str_split(substr(oct1_wt, 401, 500), '')[[1]]
oct_wt_6 = str_split(substr(oct1_wt, 501, 550), '')[[1]]

#surface plot
SM73_1_1 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(1:100),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(1, 100),
                      labels = oct_wt_1,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_2 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(101:200),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(101, 200),
                      labels = oct_wt_2,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_3 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(201:300),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(201, 300),
                      labels = oct_wt_3,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_4 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(301:400),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(301, 400),
                      labels = oct_wt_4,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")


SM73_1_5 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(401:500),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(401, 500),
                      labels = oct_wt_5,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_6 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(501:550),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(501, 550),
                      labels = oct_wt_6,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="right"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_DMS = ggarrange(SM73_1_1, SM73_1_2, SM73_1_3, SM73_1_4, SM73_1_5, SM73_1_6,
                        nrow = 6, ncol = 1)

ggsave("Plots/Heatmap_SM73_1_OCT1.pdf", plot = SM73_1_DMS, height = 11, width = 8.5)
ggsave("Plots/Heatmap_SM73_1_OCT1.png", plot = SM73_1_DMS, height = 11, width = 8.5)
```

OCT1 heatmap - GFP sorting (abundance)
```{r}

order <- c('D_1', 'H', 'K', 'R', 'D', 'E',
          'C', 'M', 'N', 'Q', 'S', 'T', 'A', 'I', 'L', 'V', 'W', 'F',
          'Y', 'G', 'P')

heatmap_limits = c(-1,1)

oct1_wt = "MPTVDDILEQVGESGWFQKQAFLILCLLSAAFAPICVGIVFLGFTPDHHCQSPGVAELSQRCGWSPAEELNYTVPGLGPAGEAFLGQCRRYEVDWNQSALSCVDPLASLATNRSHLPLGPCQDGWVYDTPGSSIVTEFNLVCADSWKLDLFQSCLNAGFLFGSLGVGYFADRFGRKLCLLGTVLVNAVSGVLMAFSPNYMSMLLFRLLQGLVSKGNWMAGYTLITEFVGSGSRRTVAIMYQMAFTVGLVALTGLAYALPHWRWLQLAVSLPTFLFLLYYWCVPESPRWLLSQKRNTEAIKIMDHIAQKNGKLPPADLKMLSLEEDVTEKLSPSFADLFRTPRLRKRTFILMYLWFTDSVLYQGLILHMGATSGNLYLDFLYSALVEIPGAFIALITIDRVGRIYPMAMSNLLAGAACLVMIFISPDLHWLNIIIMCVGRMGITIAIQMICLVNAELYPTFVRNLGVMVCSSLCDIGGIITPFIVFRLREVWQALPLILFAVLGLLAAGVTLLLPETKGVALPETMKDAENLGRKAKPKENTIYLKVQTSEPSGT"

oct_wt_1 = str_split(substr(oct1_wt, 1, 100), '')[[1]]
oct_wt_2 = str_split(substr(oct1_wt, 101, 200), '')[[1]]
oct_wt_3 = str_split(substr(oct1_wt, 201, 300), '')[[1]]
oct_wt_4 = str_split(substr(oct1_wt, 301, 400), '')[[1]]
oct_wt_5 = str_split(substr(oct1_wt, 401, 500), '')[[1]]
oct_wt_6 = str_split(substr(oct1_wt, 501, 550), '')[[1]]

#surface plot
SM73_GFP_1 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(1:100),], 
                      aes(x = pos, y = factor(variants, level = order), fill = GFP_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(1, 100),
                      labels = oct_wt_1,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_GFP_2 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(101:200),], 
                      aes(x = pos, y = factor(variants, level = order), fill = GFP_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(101, 200),
                      labels = oct_wt_2,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_GFP_3 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(201:300),], 
                      aes(x = pos, y = factor(variants, level = order), fill = GFP_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(201, 300),
                      labels = oct_wt_3,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_GFP_4 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(301:400),], 
                      aes(x = pos, y = factor(variants, level = order), fill = GFP_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(301, 400),
                      labels = oct_wt_4,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")


SM73_GFP_5 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(401:500),], 
                      aes(x = pos, y = factor(variants, level = order), fill = GFP_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(401, 500),
                      labels = oct_wt_5,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="none"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_GFP_6 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(501:550),], 
                      aes(x = pos, y = factor(variants, level = order), fill = GFP_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=heatmap_limits) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(501, 550),
                      labels = oct_wt_6,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 4),
    axis.text = element_text(size = 4),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5, family = "mono"),
    axis.ticks = element_blank(),
    legend.position="right"
  ) +
  labs(y = "Mutation", x = "Position")

SM73_GFP = ggarrange(SM73_GFP_1, SM73_GFP_2, SM73_GFP_3, SM73_GFP_4, SM73_GFP_5, SM73_GFP_6,
                        nrow = 6, ncol = 1)

ggsave("Plots/Heatmap_GFP_OCT1.pdf", plot = SM73_GFP, height = 11, width = 8.5)
ggsave("Plots/Heatmap_GFP_OCT1.png", plot = SM73_GFP, height = 11, width = 8.5)
```

Map the OCT1 results to the Alphafold model(s)
```{r}

# Single-chain model.
OCT1_AF <- read.pdb("../../Structures/AF-O15245-F1-model_v2.pdb")

oct1_avg_scores <- oct1_scores %>% group_by(pos) %>% summarise(avg_0_SM73 = mean(SM73_0_score, na.rm=TRUE),
                                            avg_1_SM73 = mean(SM73_1_score, na.rm=TRUE), 
                                            avg_A = mean(GFP_score, na.rm=TRUE))

plot.bio3d(OCT1_AF$atom$b, sse=OCT1_AF, typ="l", ylab="B-factor")

x = map_scores_pdb(OCT1_AF, oct1_avg_scores, "avg_0_SM73")
write.pdb(x, file="../../Structures/oct1_AF_avg_0_2.pdb")

x = map_scores_pdb(OCT1_AF, oct1_avg_scores, "avg_1_SM73")
write.pdb(x, file="../../Structures/oct1_AF_avg_1_2.pdb")

x = map_scores_pdb(OCT1_AF, oct1_avg_scores, "avg_A")
write.pdb(x, file="../../Structures/oct1_AF_avg_A_2.pdb")

```

Compare the inward and open states
```{r}
OCT1_in <- read.pdb("../../Structures/OCT1_in.pdb")
OCT1_out <- read.pdb("../../Structures/OCT1_out.pdb")

## Atom Selection indices
inds_in <- atom.select(OCT1_in, "calpha")
inds_out <- atom.select(OCT1_out, "calpha")

## Reference contact map
ref.cont_in <- cmap( OCT1_in$xyz[inds_in$xyz], dcut=9, scut=3)
ref.cont_out <- cmap( OCT1_out$xyz[inds_out$xyz], dcut=9, scut=3)

plot.cmap(ref.cont_in, main="Contact map (inward)")
plot.cmap(ref.cont_out, main="Contact map (outward)")

plot.cmap(ref.cont_in-ref.cont_out, main="Contact change map (in, not out)")
plot.cmap(ref.cont_out-ref.cont_in, main="Contact change map (out, not in)")

```





```{r}
filled.contour(dm(OCT1_in, inds="calpha"), nlevels = 50)

# Downlaod and align two PDB files
pdbs <- pdbaln(list(OCT1_in, OCT1_out), web.args=list(email='cbmacdo@umich.edu'))

# Get distance matrix
a <- dm.xyz(pdbs$xyz[1,])
b <- dm.xyz(pdbs$xyz[2,])

# Calculate DDM
c <- a - b

# Plot DDM
plot(c,key=FALSE, grid=FALSE)

plot(c, axis.tick.space=50,
     resnum.1=pdbs$resno[1,],
     resnum.2=pdbs$resno[2,],
     grid.col="black",
     xlab="Residue No. (OCT1_in)", ylab="Residue No. (OCT1_out)")

l <- dm.xyz(OCT1_in$xyz, grpby=OCT1_in$atom[,"resno"], scut=3)

plot(l)

```


```{r}
long.cont_in<-melt(ref.cont_in, c("x", "y"), value.name = "z")
long.cont_out<-melt(ref.cont_out, c("x", "y"), value.name = "z")
long.cont_diff<-melt(ref.cont_in - ref.cont_out, c("x", "y"), value.name = "z")

#longData<-longData[longData$value!=0,]

ggplot(long.cont_diff, aes(x = x, y = y)) + 
  geom_tile(aes(fill=z)) + 
  scale_fill_gradient(low="white", high="red", na.value="white") +
  theme_classic()
```


```{r}
pdb_test <- read.pdb( "5p21" ) 

##- Single structure distance matrix
 k <- dm(pdb_test, inds="calpha", mask.lower=FALSE)
 gg.mat(k)

 ## Add secondary structure 'annotation layer' to plot
 p <- gg.mat(k) + gg_sse(pdb_test)  ## save in an object 'p'
 p  ## produce the plot

```