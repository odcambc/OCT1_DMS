---
title: "Enrich2 output parsing and plotting - for OCT1"
output: html_notebook
---

```{r}
library(ggplot2)
library(gglorenz)
library(readr)
library(stringr)
library(dplyr)
library(hrbrthemes)
library(tidyverse)
library(ggthemes)
library(ggridges)
library(ggmsa)
library(bio3d)
#library(ggbraid)
source("dms_analysis_utilities.R")
```

Import the data for plotting

```{r}
# Enrich2 score files
oct1_scores_file ="../data/Enrich2/Oct1_full/tsv/OCT1_full_exp/main_identifiers_scores.tsv"
oct1_scores_shared_file ="../data/Enrich2/Oct1_full/tsv/OCT1_full_exp/main_identifiers_scores_shared.tsv"

oct1_variantscore_colnames <- c("hgvs", "SE", "epsilon", "score")
oct1_variantscore_coltypes <- c("character", "numeric", "numeric", "numeric")

oct1_scores <- read_delim(oct1_scores_file, col_names = oct1_variantscore_colnames, skip=3)
oct1_scores <- process_hgvs_df(oct1_scores)

oct1_variantscore_colnames <- c("hgvs", "SM73_0_SE", "SM73_0_epsilon", "SM73_0_score", "SM73_1_SE", "SM73_1_epsilon", "SM73_1_score", "GFP_SE", "GFP_epsilon", "GFP_score")
oct1_variantscore_coltypes <- c("character", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric")

oct1_shared_colnames <- c("hgvs", "SM73_0_SE_R1", "SM73_0_score_R1",
                                "SM73_0_SE_R2", "SM73_0_score_R2",
                                "SM73_0_SE_R3", "SM73_0_score_R3",
                                "SM73_1_SE_R1", "SM73_1_score_R1",
                                "SM73_1_SE_R2", "SM73_1_score_R2",
                                "SM73_1_SE_R3", "SM73_1_score_R3",
                                "GFP_SE_R1", "GFP_score_R1",
                                "GFP_SE_R2", "GFP_score_R2",
                                "GFP_SE_R3", "GFP_score_R3")
oct1_shared_coltypes <- c("character", "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric",
                                "numeric", "numeric")

oct1_scores <- read_delim(oct1_scores_file, col_names = oct1_variantscore_colnames, skip=3)
oct1_scores <- process_hgvs_df(oct1_scores)

oct1_scores_shared <- read_delim(oct1_scores_shared_file, col_names = oct1_shared_colnames, skip=5)

# Enrich2 does not calculate scores if a variant in a replicate goes to 0 counts at some point.
# This calculates a score for those cases by averaging the scores for the other replicates.
oct1_scores_shared <- oct1_scores_shared %>%  rowwise() %>%
                                mutate(SM73_0_score = mean(c_across(starts_with("SM73_0_score")), na.rm=TRUE),
                                SM73_1_score = mean(c_across(starts_with("SM73_1_score")), na.rm=TRUE),
                                GFP_score = mean(c_across(starts_with("GFP_score")), na.rm=TRUE))

oct1_scores_shared <- process_hgvs_df(oct1_scores_shared %>% select(c(hgvs, SM73_0_score, SM73_1_score, GFP_score)))
oct1_scores_shared$is.wt = oct1_scores_shared$mutation_type == "S"
oct1_scores <- oct1_scores_shared

```

```{r}

ggplot(oct1_scores %>% filter(mutation_type != "X")) +
  geom_density(aes(x = SM73_0_score), size=2) +
  xlab("Enrich2 score (0 µM [SM73])") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  scale_color_brewer(
    type = "seq",
    palette = 'Oranges',
    direction = 1,
    aesthetics = 'color'
  ) +
  facet_grid(rows = vars(mutation_type))

ggplot(oct1_scores %>% filter(mutation_type != "X")) +
  geom_density(aes(x = SM73_1_score), size=2) +
  xlab("Enrich2 score (1 µM [SM73])") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  scale_color_brewer(
    type = "seq",
    palette = 'Oranges',
    direction = 1,
    aesthetics = 'color'
  ) +
  facet_grid(rows = vars(mutation_type))

ggplot(oct1_scores %>% filter(mutation_type != "X")) +
  geom_density(aes(x = GFP_score), size=2) +
  xlab("Enrich2 score (GFP)") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  scale_color_brewer(
    type = "seq",
    palette = 'Oranges',
    direction = 1,
    aesthetics = 'color'
  ) +
  facet_grid(rows = vars(mutation_type))

```

```{r}
physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1"
                    )

ggplot(data=oct1_scores, aes(pos, y=factor(variants, level = physical_order), fill=SM73_0_score)) + 
  geom_tile(color = "white",
            lwd = 1.5,
            linetype = 0.1) +
  scale_fill_gradient2(midpoint = 0, high = "blue", mid = "white", low = "red") + 
  coord_fixed() + 
  xlab("Position") + ylab("Variant") + ggtitle("OCT1 Enrich scores (0 µM [SM73])") + 
  theme_classic(base_family="Helvetica") + 
  theme(text = element_text(size=25),
        axis.text.y = element_text(size=5)
          )
ggsave("Plots/OCT1_heatmap_0SM73.pdf", height = 9 , width = 35)


ggplot(data=oct1_scores, aes(pos, y=factor(variants, level = physical_order), fill=SM73_1_score)) + 
  geom_tile(color = "white",
            lwd = 1.5,
            linetype = 0.1) +
  scale_fill_gradient2(midpoint = 0, high = "blue", mid = "white", low = "red") + 
  coord_fixed() + 
  xlab("Position") + ylab("Variant") + ggtitle("OCT1 Enrich scores (1 µM [SM73])") + 
  theme_classic(base_family="Helvetica") + 
  theme(text = element_text(size=25),
        axis.text.y = element_text(size=5)
          )
ggsave("Plots/OCT1_heatmap_1SM73.pdf", height = 9 , width = 35)


ggplot(data=oct1_scores, aes(pos, y=factor(variants, level = physical_order), fill=GFP_score)) + 
  geom_tile(color = "white",
            lwd = 1.5,
            linetype = 0.1) +
  scale_fill_gradient2(midpoint = 0, low = "blue", mid = "white", high = "red") + 
  coord_fixed() + 
  xlab("Position") + ylab("Variant") + ggtitle("OCT1 Enrich scores (Abundance)") + 
  theme_classic(base_family="Helvetica") + 
  theme(text = element_text(size=25),
        axis.text.y = element_text(size=5)
          )
ggsave("Plots/OCT1_heatmap_GFP.pdf", height = 9 , width = 35)

```

```{r}

variant_df = oct1_scores %>% filter(mutation_type != "X")

physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1")

ggplot(data = variant_df, aes(x=pos, y=GFP_score)) + 
  geom_point() +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  labs(x = "Position", y = "Enrich score  (Abundance)") + 
  theme_classic()

ggplot(data = variant_df,
       aes(x=factor(mutation_type, level = physical_order),
            y=GFP_score)) + 
  geom_hline(yintercept=0) +
  geom_violin(outlier.colour=NA) +
  xlab("Variant") + ylab("Enrich score  (Abundance)") +
  labs(x = "Mutation") +
  theme_classic()

ggplot(data = variant_df %>% 
        group_by(pos) %>% summarise(score = mean(GFP_score, na.rm=TRUE), pos = first(pos), mutation_type=first(mutation_type)), aes(x=pos, y=score, fill=mutation_type)) +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  geom_bar(stat="identity") +
  geom_vline(xintercept = 100, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 200, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 300, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 400, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 500, linestyle = 'dashed', lty = 2) + 
  theme_classic()

ggplot(variant_df) +
  geom_density(aes(x = GFP_score), bw=0.01, size=1) +
  xlab("Enrich2 score (Abundance)") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  facet_grid(rows = vars(mutation_type))

ggplot(variant_df, aes(x = GFP_score, y = mutation_type)) +
  geom_density_ridges(scale=1) +
  geom_point(aes(color=pos), 
    position = position_jitter(height=0.05, width = 0), size=0.25) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_color_gradient(high = "#49006a", low = "#fff7f3", aesthetics = "color") +
  xlab("Enrich2 score (Abundance)") +
  ylab("Mutation type") +
  labs(colour = "Residue position") +
  theme_ridges()

```

```{r}
variant_df = oct1_scores %>% filter(mutation_type != "X")

physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1")

ggplot(data = variant_df, aes(x=pos, y=SM73_0_score)) + 
  geom_point() +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  labs(x = "Position", y = "Enrich score  (0 µM [SM73])") + 
  theme_classic()

ggplot(data = variant_df,
       aes(x=factor(mutation_type, level = physical_order),
            y=SM73_0_score)) + 
  geom_hline(yintercept=0) +
  geom_violin(outlier.colour=NA) +
  xlab("Variant") + ylab("score") +
  labs(x = "Mutation") +
  theme_classic()

ggplot(data = variant_df %>% 
        group_by(pos) %>% summarise(score = mean(SM73_0_score, na.rm=TRUE), pos = first(pos), mutation_type=first(mutation_type)), aes(x=pos, y=score, fill=mutation_type)) +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  geom_bar(stat="identity") +
  geom_vline(xintercept = 100, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 200, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 300, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 400, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 500, linestyle = 'dashed', lty = 2) + 
  theme_classic()

ggplot(variant_df) +
  geom_density(aes(x = SM73_0_score), bw=0.01, size=1) +
  xlab("Enrich2 score") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  facet_grid(rows = vars(mutation_type))

ggplot(variant_df, aes(x = SM73_0_score, y = mutation_type)) +
  geom_density_ridges(scale=1) +
  geom_point(aes(color=pos), 
    position = position_jitter(height=0.05, width = 0), size=0.25) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_color_gradient(high = "#49006a", low = "#fff7f3", aesthetics = "color") +
  xlab("Enrich2 score") +
  ylab("Mutation type") +
  labs(colour = "Residue position") +
  theme_ridges()

```

```{r}
variant_df = oct1_scores %>% filter(mutation_type != "X")

physical_order <- c("G", "A", "I", "L", "V",
                    "C", "M",
                    "S", "T", 
                    "K", "R", "H",
                    "D", "E", "N", "Q",
                    "F", "W", "Y",
                    "P",
                    "D_1")

ggplot(data = variant_df, aes(x=pos, y=SM73_1_score)) + 
  geom_point() +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  labs(x = "Position") + 
  theme_classic()

ggplot(data = variant_df,
       aes(x=factor(mutation_type, level = physical_order),
            y=SM73_1_score)) + 
  geom_hline(yintercept=0) +
  geom_violin(outlier.colour=NA) +
  xlab("Variant") + ylab("score") +
  labs(x = "Mutation") +
  theme_classic()

ggplot(data = variant_df %>% 
        group_by(pos) %>% summarise(score = mean(SM73_1_score, na.rm=TRUE), pos = first(pos), mutation_type=first(mutation_type)), aes(x=pos, y=score, fill=mutation_type)) +
  facet_grid(rows = vars(mutation_type), scales = "free") +
  geom_bar(stat="identity") +
  geom_vline(xintercept = 100, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 200, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 300, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 400, linestyle = 'dashed', lty = 2) + 
  geom_vline(xintercept = 500, linestyle = 'dashed', lty = 2) + 
  theme_classic()

ggplot(variant_df) +
  geom_density(aes(x = SM73_1_score), bw=0.01, size=1) +
  xlab("Enrich2 score") + 
  ylab("Density") + 
  geom_vline(xintercept = 0, linetype="dotted") +
  theme_classic(base_family = "Helvetica") + 
  facet_grid(rows = vars(mutation_type))

ggplot(variant_df, aes(x = SM73_1_score, y = mutation_type)) +
  geom_density_ridges(scale=1) +
  geom_point(aes(color=pos), 
    position = position_jitter(height=0.05, width = 0), size=0.25) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_color_gradient(high = "#49006a", low = "#fff7f3", aesthetics = "color") +
  xlab("Enrich2 score") +
  ylab("Mutation type") +
  labs(colour = "Residue position") +
  theme_ridges()
```
OCT1 heatmap
```{r}

order <- c('D_1','H', 'K', 'R', 'D', 'E',
          'C','M','N','Q','S','T','A','I','L','V','W','F',
          'Y','G','P')

oct1_wt = "MPTVDDILEQVGESGWFQKQAFLILCLLSAAFAPICVGIVFLGFTPDHHCQSPGVAELSQRCGWSPAEELNYTVPGLGPAGEAFLGQCRRYEVDWNQSALSCVDPLASLATNRSHLPLGPCQDGWVYDTPGSSIVTEFNLVCADSWKLDLFQSCLNAGFLFGSLGVGYFADRFGRKLCLLGTVLVNAVSGVLMAFSPNYMSMLLFRLLQGLVSKGNWMAGYTLITEFVGSGSRRTVAIMYQMAFTVGLVALTGLAYALPHWRWLQLAVSLPTFLFLLYYWCVPESPRWLLSQKRNTEAIKIMDHIAQKNGKLPPADLKMLSLEEDVTEKLSPSFADLFRTPRLRKRTFILMYLWFTDSVLYQGLILHMGATSGNLYLDFLYSALVEIPGAFIALITIDRVGRIYPMAMSNLLAGAACLVMIFISPDLHWLNIIIMCVGRMGITIAIQMICLVNAELYPTFVRNLGVMVCSSLCDIGGIITPFIVFRLREVWQALPLILFAVLGLLAAGVTLLLPETKGVALPETMKDAENLGRKAKPKENTIYLKVQTSEPSGT"

oct_wt_1 = str_split(substr(oct1_wt, 1, 100), '')[[1]]
oct_wt_2 = str_split(substr(oct1_wt, 101, 200), '')[[1]]
oct_wt_3 = str_split(substr(oct1_wt, 201, 300), '')[[1]]
oct_wt_4 = str_split(substr(oct1_wt, 301, 400), '')[[1]]
oct_wt_5 = str_split(substr(oct1_wt, 401, 500), '')[[1]]
oct_wt_6 = str_split(substr(oct1_wt, 501, 550), '')[[1]]

#surface plot
SM73_1_1 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(1:100),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=c(-3,3)) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(1, 100),
                      labels = oct_wt_1,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 5),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5)
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_2 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(101:200),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=c(-5,5)) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(101, 200),
                      labels = oct_wt_2,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 5),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5)
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_3 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(201:300),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=c(-3,3)) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(201, 300),
                      labels = oct_wt_3,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 5),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5)
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_4 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(301:400),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=c(-3,3)) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(301, 400),
                      labels = oct_wt_4,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 5),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5)
  ) +
  labs(y = "Mutation", x = "Position")


SM73_1_5 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(401:500),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=c(-3,3)) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(401, 500),
                      labels = oct_wt_5,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 5),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5)
  ) +
  labs(y = "Mutation", x = "Position")

SM73_1_6 = ggplot(data = oct1_scores[oct1_scores$pos %in% c(501:550),], 
                      aes(x = pos, y = factor(variants, level = order), fill = SM73_1_score)) +
  geom_tile(aes(color = as.factor(is.wt)), size = 0.2) +
  scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0,l1=0.2, l3 = 0.2, p1=0.9, p3 = .4, p4 = 0.9,rev=TRUE, na.value = 'lightyellow',limits=c(-3,3)) + 
  scale_color_manual(values = c(NA,'green')) +
  scale_x_continuous(breaks = seq(0, 550, by = 5),
                     expand = c(0,0),
                     sec.axis = sec_axis(
                      trans = ~.,
                      name = "Sequence",
                      breaks = seq(501, 550),
                      labels = oct_wt_6,
                      guide = derive()
                    )) +
  coord_fixed(ratio = 1) +
  theme(
    panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
    panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                    colour = "lightgray"), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 5),
    axis.text.x.top = element_text(angle = 0, hjust = 0.5)
  ) +
  labs(y = "Mutation", x = "Position")


SM73_DMS = ggarrange(SM73_1_1, SM73_1_2, SM73_1_3, SM73_1_4, SM73_1_5, SM73_1_6,
                        nrow = 6, ncol = 1)
SM73_DMS
annotate_figure(SM73_DMS, fig.lab = '1 µM [SM73]')

ggsave("Plots/OCT1_SM731_heatmap.pdf", height = 11, width = 8.5)
ggsave("Plots/OCT1_SM731_heatmap.png", height = 11, width = 8.5)

```

Map the OCT1 results to the Alphafold model
```{r}

# Single-chain model.
OCT1_AF <- read.pdb("Structures/AF-O15245-F1-model_v2.pdb")

oct1_avg_scores <- oct1_scores %>% group_by(pos) %>% summarise(avg_0_SM73 = mean(SM73_0_score, na.rm=TRUE),
                                            avg_1_SM73 = mean(SM73_1_score, na.rm=TRUE), 
                                            avg_A = mean(GFP_score, na.rm=TRUE))

plot.bio3d(OCT1_AF$atom$b, sse=OCT1_AF, typ="l", ylab="B-factor")

x = map_scores_pdb(OCT1_AF, oct1_avg_scores, "avg_0_SM73")
write.pdb(x, file="Structures/oct1_AF_avg_0_2.pdb")

x = map_scores_pdb(OCT1_AF, oct1_avg_scores, "avg_1_SM73")
write.pdb(x, file="Structures/oct1_AF_avg_1_2.pdb")

x = map_scores_pdb(OCT1_AF, oct1_avg_scores, "avg_A")
write.pdb(x, file="Structures/oct1_AF_avg_A_2.pdb")

```